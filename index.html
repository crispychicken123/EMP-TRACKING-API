<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken - HR Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --cc-red: #E4002B;
            --cc-black: #1a1a1a;
            --cc-white: #ffffff;
            --cc-gray: #f4f6f9;
            --cc-border: #e0e0e0;
        }

        [data-theme="dark"] {
            --cc-black: #f0f0f0;
            --cc-white: #1a1a1a;
            --cc-gray: #2a2a2a;
            --cc-border: #444;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--cc-gray);
            margin: 0;
            padding: 0;
            color: var(--cc-black);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- PRINT STYLES (CRITICAL FIX) --- */
        @media print {
            @page { margin: 1cm; size: A4; }
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea {
                position: absolute; left: 0; top: 0; width: 100%;
                background: white; color: black; padding: 20px; border: none; z-index: 9999;
            }
            .print-header { text-align: center; border-bottom: 2px solid var(--cc-red); padding-bottom: 10px; margin-bottom: 20px; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
            .print-box { border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
            .print-label { font-weight: bold; font-size: 12px; color: #555; }
            .print-value { font-size: 14px; margin-top: 2px; }
            .print-status { text-align: center; font-weight: bold; font-size: 18px; margin: 20px 0; padding: 10px; border-radius: 8px; }
            .print-status.ready { background-color: #d4edda; color: #155724; }
            .print-status.pending { background-color: #fff3cd; color: #856404; }
        }

        /* --- HEADER --- */
        header {
            background-color: var(--cc-black); color: var(--cc-white);
            padding: 12px 24px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 4px solid var(--cc-red); position: sticky; top: 0; z-index: 100;
        }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .chef-icon { font-size: 28px; background: var(--cc-red); color: white; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .app-title h1 { margin: 0; font-size: 18px; font-weight: 700; }
        .app-title span { font-size: 11px; opacity: 0.7; text-transform: uppercase; }

        /* --- CONTROLS --- */
        .controls {
            padding: 15px 24px; background: var(--cc-white); display: flex; gap: 12px; align-items: center;
            border-bottom: 1px solid var(--cc-border); flex-wrap: wrap; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-wrapper { flex: 1; min-width: 200px; position: relative; }
        .search-wrapper input {
            width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ccc; border-radius: 20px;
            font-size: 14px; background-color: var(--cc-white); color: var(--cc-black);
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #888; }

        .filter-wrapper { display: flex; gap: 8px; align-items: center; }
        .filter-wrapper select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; background-color: var(--cc-white); color: var(--cc-black); }

        button {
            padding: 9px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;
            color: white; display: inline-flex; align-items: center; gap: 6px; transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        
        .btn-quick { background-color: #6f42c1; } /* Purple */
        .btn-import { background-color: #6610f2; } /* Indigo */
        .btn-branch { background-color: #444; }
        .btn-export { background-color: #28a745; } /* Green */
        .btn-email { background-color: #007bff; } /* Blue */
        .btn-add { background-color: var(--cc-red); }
        .btn-print-id { background-color: #17a2b8; } /* Cyan */
        .btn-reset { background-color: transparent; border: 1px solid #ccc; color: #666; font-size: 11px; }

        /* --- DASHBOARD --- */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; padding: 20px 24px 0 24px; }
        .stat-card {
            background: var(--cc-white); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-top: 4px solid transparent; display: flex; flex-direction: column; align-items: center;
        }
        .stat-number { font-size: 28px; font-weight: 800; color: var(--cc-black); margin-bottom: 2px; }
        .stat-label { font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase; }
        
        .stat-total { border-color: #666; }
        .stat-working { border-color: #28a745; }
        .stat-warning { border-color: #ffc107; }
        .stat-issue { border-color: #dc3545; }

        /* --- TABLE --- */
        .table-container {
            margin: 20px 24px 24px 24px; background: var(--cc-white); border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--cc-border); overflow: hidden;
        }
        .table-header { padding: 12px 20px; background: #f8f9fa; border-bottom: 1px solid var(--cc-border); display: flex; justify-content: space-between; align-items: center; }
        .table-scroll { overflow-x: auto; max-height: calc(100vh - 420px); }
        table { width: 100%; border-collapse: collapse; min-width: 2200px; }
        
        th {
            background-color: #f8f9fa; color: #444; font-weight: 600; font-size: 11px; text-transform: uppercase;
            padding: 10px 8px; text-align: left; border-bottom: 2px solid var(--cc-border); position: sticky; top: 0; z-index: 10;
        }
        td { padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; color: var(--cc-black); vertical-align: middle; }
        tr:hover { background-color: rgba(0,0,0,0.02); }
        tr.new-staff { background-color: rgba(0, 123, 255, 0.05); }

        /* --- STATUS BADGES --- */
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; display: inline-block; white-space: nowrap; }
        .status-working { background-color: #d4edda; color: #155724; } 
        .status-expiring { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; } 
        .status-expired { background-color: #f8d7da; color: #721c24; } 
        .status-missing { background-color: #f5c6cb; color: #721c24; border: 1px solid #e2e6ea; } 
        .status-resigned { background-color: #6c757d; color: white; border: 1px solid #5a6268; } 

        .progress-bg { background-color: #eee; border-radius: 10px; width: 80px; height: 8px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 5px; }
        .progress-fill { height: 100%; background-color: var(--cc-red); }

        .action-btn { background: none; border: none; cursor: pointer; padding: 4px; font-size: 14px; }
        .btn-edit { color: #007bff; }
        .btn-del { color: #dc3545; }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content {
            background: var(--cc-white); padding: 0; border-radius: 12px; width: 90%; max-width: 1000px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; display: flex; flex-direction: column;
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--cc-border); display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--cc-border); display: flex; justify-content: space-between; gap: 10px; background: #fcfcfc; }
        
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .form-group { margin-bottom: 5px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 11px; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background-color: var(--cc-white); color: var(--cc-black); }
        .form-group input:focus, .form-group select:focus { border-color: var(--cc-red); }
        .divider { grid-column: span 3; border-top: 1px solid var(--cc-border); margin: 10px 0 5px 0; color: var(--cc-red); font-weight: bold; font-size: 12px; }
        
        /* Branch List Styling */
        .branch-list-ul { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; margin-top: 15px; }
        .branch-list-ul li { padding: 8px 15px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .branch-list-ul li:hover { background-color: #f8f9fa; }
        
        .branch-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .branch-stat-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; background: #fafafa; }
        .branch-stat-count { font-size: 24px; font-weight: bold; color: var(--cc-red); display: block; }
        .branch-stat-name { font-size: 12px; font-weight: 600; text-transform: uppercase; }
        
        .toast {
            visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center;
            border-radius: 50px; padding: 14px 24px; position: fixed; z-index: 2000; bottom: 30px;
            left: 50%; transform: translateX(-50%) translateY(20px); box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-size: 14px; opacity: 0; transition: all 0.3s;
        }
        .toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.warning { background-color: #ffc107; color: #333; }

        /* Notification Panel */
        .notification-panel {
            position: fixed; top: 70px; right: 20px; width: 320px; background: var(--cc-white);
            border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 99;
            transform: translateX(350px); transition: transform 0.3s ease; max-height: 400px; overflow: hidden; display: flex; flex-direction: column;
        }
        .notification-panel.open { transform: translateX(0); }
        .notification-header { padding: 12px 15px; background: var(--cc-red); color: white; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .notification-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .notification-item { padding: 10px 15px; border-bottom: 1px solid var(--cc-border); font-size: 12px; display: flex; align-items: center; gap: 10px; }
        .notification-item:last-child { border-bottom: none; }
        .notification-icon { font-size: 16px; width: 20px; text-align: center; }
        .notification-icon.expired { color: #dc3545; }
        .notification-icon.warning { color: #ffc107; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; margin-bottom: 2px; }
        .notification-date { color: #666; font-size: 11px; }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="logo-area">
            <div class="chef-icon">üë®‚Äçüç≥</div>
            <div class="app-title">
                <h1>CRISPY CHICKEN HR</h1>
                <span>Complete Management System</span>
            </div>
        </div>
        <div style="font-size: 11px; color: #ddd;">Last Saved: <span id="lastSavedTime">--</span></div>
    </header>

    <!-- Controls -->
    <div class="controls">
        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Search ID, Name, or Branch..." onkeyup="filterData()">
        </div>
        
        <button class="btn-print-id" onclick="printByIdInput()" title="Print Status for ID in search box">
            <i class="fas fa-file-pdf"></i> Print Status
        </button>

        <div class="filter-wrapper">
            <select id="statusFilter" onchange="filterData()">
                <option value="">All Status</option>
                <option value="working">üü¢ Working Fine</option>
                <option value="expiring">üü° Expiring Soon (30d)</option>
                <option value="expired">üî¥ Expired</option>
                <option value="missing">üî¥ Missing Docs</option>
                <option value="resigned">üî¥ Resigned</option>
            </select>
            <select id="branchFilter" onchange="filterData()">
                <option value="">All Branches</option>
            </select>
        </div>
        
        <button class="btn-quick" onclick="openQuickAddModal()">‚ö° Quick Add</button>
        <button class="btn-import" onclick="document.getElementById('fileImport').click()">üì• Import</button>
        <input type="file" id="fileImport" style="display:none" onchange="importData(this)">
        
        <button class="btn-branch" onclick="openBranchModal()">üè¢ Branches</button>
        <button class="btn-export" onclick="exportToCSV()">üì• Excel</button>
        <button class="btn-email" onclick="sendReportEmail()">üìß Email</button>
        <button class="btn-add" onclick="openAddModal()">+ New Staff</button>
    </div>

    <!-- Stats -->
    <div class="dashboard">
        <div class="stat-card stat-total">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">Total Staff</div>
        </div>
        <div class="stat-card stat-working">
            <div class="stat-number" id="workingCount" style="color: #28a745;">0</div>
            <div class="stat-label">Working Fine</div>
        </div>
        <div class="stat-card stat-warning">
            <div class="stat-number" id="expiringCount" style="color: #ffc107;">0</div>
            <div class="stat-label">Expiring</div>
        </div>
        <div class="stat-card stat-issue">
            <div class="stat-number" id="issueCount" style="color: #dc3545;">0</div>
            <div class="stat-label">Issues</div>
        </div>
    </div>

    <!-- Main Table -->
    <div class="table-container">
        <div class="table-header">
            <div class="table-title">Staff Records</div>
            <div class="table-actions">
                <button onclick="openHelpModal()" title="Help"><i class="fas fa-question-circle"></i></button>
            </div>
        </div>
        <div class="table-scroll">
            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Nationality</th>
                        <th>Joining Date</th>
                        <th>Passport Exp.</th>
                        <th>Medical Exp.</th>
                        <th>Branch</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody">
                    <!-- JS Data -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 1. BRANCH DASHBOARD MODAL -->
    <div id="branchModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Manage Branches</h3>
                <button class="action-btn" onclick="closeModal('branchModal')" style="color: #666; font-size: 18px;">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Add New Branch</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newBranchName" placeholder="Enter branch name..." onkeypress="if(event.key==='Enter') addNewBranch()">
                        <button class="btn-add" onclick="addNewBranch()">Add</button>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Staff Distribution</h4>
                <div class="branch-stats-grid" id="branchStatsGrid">
                    <!-- JS Will Populate Stats Here -->
                </div>

                <h4 style="margin-top: 20px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Existing Branches</h4>
                <ul id="branchListDisplay" class="branch-list-ul"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn-reset" onclick="closeModal('branchModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- 2. QUICK ADD MODAL -->
    <div id="quickAddModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>‚ö° Quick Add Staff</h3>
                <button class="action-btn" onclick="closeModal('quickAddModal')" style="color: #666; font-size: 18px;">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>ID <span style="color:red">*</span></label>
                        <input type="text" id="qkId" placeholder="e.g. STF100">
                    </div>
                    <div class="form-group">
                        <label>Name <span style="color:red">*</span></label>
                        <input type="text" id="qkName" placeholder="Full Name">
                    </div>
                    <div class="form-group">
                        <label>Branch <span style="color:red">*</span></label>
                        <select id="qkBranch"><option value="">-- Select Branch --</option></select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Initial Notes</label>
                        <input type="text" id="qkNotes" placeholder="e.g. 'resign' or specific instructions">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-reset" onclick="closeModal('quickAddModal')">Cancel</button>
                <button class="btn-add" onclick="saveQuickAdd()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- 3. FULL ADD/EDIT MODAL -->
    <div id="staffModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Staff</h3>
                <button class="action-btn" onclick="closeModal('staffModal')" style="color: #666; font-size: 18px;">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="editId">
                    <div class="form-grid">
                        <div class="divider">Basic Information</div>
                        <div class="form-group">
                            <label>Employee ID</label>
                            <input type="text" id="inpId" required>
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="inpName" required>
                        </div>
                        <div class="form-group">
                            <label>Staff Type</label>
                            <select id="inpStaffType">
                                <option value="new">New Staff</option>
                                <option value="existing">Existing Staff</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nationality</label>
                            <select id="inpNationality">
                                <option value="">Select...</option>
                                <option value="JORDANIAN">JORDANIAN</option>
                                <option value="PHILIPPINES">PHILIPPINES</option>
                                <option value="INDIAN">INDIAN</option>
                                <option value="SRILANKA">SRILANKA</option>
                                <option value="NEPAL">NEPAL</option>
                                <option value="BANGLADESH">BANGLADESH</option>
                                <option value="CAMEROON">CAMEROON</option>
                                <option value="EGYPT">EGYPT</option>
                                <option value="PAKISTAN">PAKISTAN</option>
                                <option value="SYRIA">SYRIA</option>
                                <option value="MYANMAR">MYANMAR</option>
                                <option value="FILIPINO">FILIPINO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="inpGender"><option value="Male">Male</option><option value="Female">Female</option></select>
                        </div>
                        <div class="form-group">
                            <label>Branch</label>
                            <select id="inpBranch" required><option value="">-- Select Branch --</option></select>
                        </div>
                        <div class="form-group">
                            <label>Joining Date</label>
                            <input type="date" id="inpJoiningDate">
                        </div>
                        <div class="form-group">
                            <label>ID Number</label>
                            <input type="text" id="inpIdNumber">
                        </div>

                        <div class="divider">Documents</div>
                        <div class="form-group">
                            <label>Photos (0-5)</label>
                            <input type="number" id="inpPhotos" min="0" max="5" value="0">
                        </div>
                        <div class="form-group">
                            <label>CV Received?</label>
                            <select id="inpCV"><option value="false">No</option><option value="true">Yes</option></select>
                        </div>
                        <div class="form-group">
                            <label>Offer Letter?</label>
                            <select id="inpOffer"><option value="false">No</option><option value="true">Yes</option></select>
                        </div>

                        <div class="divider">Passport & Medical</div>
                        <div class="form-group">
                            <label>Passport Received?</label>
                            <select id="inpPassport"><option value="false">No</option><option value="true">Yes</option></select>
                        </div>
                        <div class="form-group">
                            <label>Passport Expiry</label>
                            <input type="date" id="inpPassExp">
                        </div>
                        <div class="form-group">
                            <label>Medical Expiry</label>
                            <input type="date" id="inpMedicalExp">
                        </div>
                        <div class="form-group">
                            <label>ID/Visa Expiry</label>
                            <input type="date" id="inpIdVisaExp">
                        </div>
                        <div class="form-group">
                            <label>Tip Center Sent?</label>
                            <select id="inpTipCenter"><option value="false">No</option><option value="true">Yes</option></select>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <input type="text" id="inpNotes" placeholder="Type 'resign' for status...">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-print-id" onclick="printCurrentModalView()">üñ®Ô∏è Print Status</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-reset" onclick="closeModal('staffModal')">Cancel</button>
                    <button class="btn-add" onclick="saveStaff()">üíæ Save Staff</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <span>Expiring Documents</span>
            <button class="action-btn" onclick="toggleNotifications()" style="color: white;"><i class="fas fa-times"></i></button>
        </div>
        <div class="notification-list" id="notificationList"></div>
    </div>

    <!-- Hidden Print Area -->
    <div id="printArea" style="display:none;"></div>
    <div id="toast" class="toast">Operation Successful</div>

    <script>
        // --- CONFIG ---
        const STORAGE_KEY_EMP = 'cc_employees_v3';
        const STORAGE_KEY_BR = 'cc_branches_v3';
        const STORAGE_KEY_THEME = 'cc_theme';
        
        let employees = [];
        let branches = ["CC Hamdan St", "CC Khaldia", "CC Muroor", "CC Shabiya 11", "CC Head Office"];
        let notifications = [];

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            checkExpiringDocuments();
        });

        function loadData() {
            try {
                const storedEmp = localStorage.getItem(STORAGE_KEY_EMP);
                const storedBr = localStorage.getItem(STORAGE_KEY_BR);
                if (storedEmp) employees = JSON.parse(storedEmp);
                if (storedBr) branches = JSON.parse(storedBr);
                updateUI();
            } catch(e) {
                console.error("Data Load Error", e);
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY_EMP, JSON.stringify(employees));
            localStorage.setItem(STORAGE_KEY_BR, JSON.stringify(branches));
            document.getElementById('lastSavedTime').innerText = new Date().toLocaleTimeString();
            updateUI();
        }

        function resetData() {
            if(confirm("Reset All Data? Cannot be undone.")) {
                localStorage.removeItem(STORAGE_KEY_EMP);
                localStorage.removeItem(STORAGE_KEY_BR);
                location.reload();
            }
        }

        // --- STATUS LOGIC ---
        function getEmployeeStatus(emp) {
            // 1. Resigned
            if (emp.notes && emp.notes.toLowerCase().includes('resign')) {
                return { label: "Resigned", class: "status-resigned", isReady: false, icon: "üî¥" };
            }
            // 2. Existing Staff
            if (emp.staffType === 'existing') {
                if (isAnyExpired(emp)) return { label: "Expired", class: "status-expired", isReady: false, icon: "üî¥" };
                if (isAnyExpiringSoon(emp)) return { label: "Expiring", class: "status-expiring", isReady: true, icon: "üü°" };
                return { label: "Working Fine", class: "status-working", isReady: true, icon: "üü¢" };
            }
            // 3. New Staff Logic
            const docsMissing = !emp.passport || !emp.cv || !emp.offerLetter || emp.photos < 5;
            if (docsMissing) return { label: "Missing Docs", class: "status-missing", isReady: false, icon: "üî¥" };
            
            if (isAnyExpired(emp)) return { label: "Expired", class: "status-expired", isReady: false, icon: "üî¥" };
            if (isAnyExpiringSoon(emp)) return { label: "Expiring", class: "status-expiring", isReady: true, icon: "üü°" };
            
            return { label: "Working Fine", class: "status-working", isReady: true, icon: "üü¢" };
        }

        function isAnyExpiringSoon(emp) {
            const today = new Date(); today.setHours(0,0,0,0);
            const check = (d) => {
                if(!d) return false;
                const diff = Math.ceil((new Date(d) - today) / (1000 * 60 * 60 * 24));
                return diff > 0 && diff <= 30;
            };
            return check(emp.passportExpiry) || check(emp.medicalExpiry) || check(emp.idVisaExpiry);
        }

        function isAnyExpired(emp) {
            const today = new Date(); today.setHours(0,0,0,0);
            const check = (d) => d ? new Date(d) <= today : false;
            return check(emp.passportExpiry) || check(emp.medicalExpiry) || check(emp.idVisaExpiry);
        }

        // --- UI UPDATES ---
        function updateUI() {
            renderBranches();
            renderTable(employees);
            updateDashboard(employees);
        }

        function updateDashboard(data) {
            let working = 0, expiring = 0, issues = 0;
            data.forEach(emp => {
                const s = getEmployeeStatus(emp);
                if (s.class === 'status-working') working++;
                else if (s.class === 'status-expiring') expiring++;
                else if (s.class === 'status-expired' || s.class === 'status-missing' || s.class === 'status-resigned') issues++;
            });
            document.getElementById('totalCount').innerText = data.length;
            document.getElementById('workingCount').innerText = working;
            document.getElementById('expiringCount').innerText = expiring;
            document.getElementById('issueCount').innerText = issues;
        }

        function renderTable(data) {
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = ''; 
            data.forEach(emp => {
                const status = getEmployeeStatus(emp);
                const row = document.createElement('tr');
                if (emp.staffType === 'new') row.className = 'new-staff';
                
                row.innerHTML = `
                    <td><span class="badge ${status.class}">${status.icon} ${status.label}</span></td>
                    <td><strong>${emp.id}</strong></td>
                    <td>${emp.name}</td>
                    <td>${emp.nationality || '-'}</td>
                    <td>${emp.joiningDate || '-'}</td>
                    <td>${emp.passportExpiry || '-'}</td>
                    <td>${emp.medicalExpiry || '-'}</td>
                    <td>${emp.branch || '-'}</td>
                    <td style="font-size:11px; max-width:100px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${emp.notes || ''}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editEmployee('${emp.id}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-del" onclick="deleteEmployee('${emp.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterData() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const branchFilter = document.getElementById('branchFilter').value;
            
            const filtered = employees.filter(emp => {
                const matchesSearch = !query || emp.id.toLowerCase().includes(query) || emp.name.toLowerCase().includes(query);
                const matchesBranch = !branchFilter || emp.branch === branchFilter;
                
                const s = getEmployeeStatus(emp);
                let matchesStatus = true;
                if(statusFilter) {
                    if(statusFilter === 'working') matchesStatus = (s.class === 'status-working');
                    else if(statusFilter === 'expiring') matchesStatus = (s.class === 'status-expiring');
                    else if(statusFilter === 'expired') matchesStatus = (s.class === 'status-expired');
                    else if(statusFilter === 'missing') matchesStatus = (s.class === 'status-missing');
                    else if(statusFilter === 'resigned') matchesStatus = (s.class === 'status-resigned');
                }
                
                return matchesSearch && matchesBranch && matchesStatus;
            });
            
            renderTable(filtered);
        }

        // --- BRANCH MANAGEMENT ---
        function renderBranches() {
            ['qkBranch', 'inpBranch', 'branchFilter'].forEach(id => {
                const sel = document.getElementById(id);
                const isFilter = id === 'branchFilter';
                sel.innerHTML = isFilter ? '<option value="">All Branches</option>' : '<option value="">-- Select Branch --</option>';
                branches.sort().forEach(b => { sel.innerHTML += `<option value="${b}">${b}</option>`; });
            });

            const list = document.getElementById('branchListDisplay');
            list.innerHTML = '';
            branches.sort().forEach(b => {
                list.innerHTML += `<li>${b} <button style="color:red; background:none; border:none; cursor:pointer;" onclick="deleteBranch('${b}')">x</button></li>`;
            });

            const grid = document.getElementById('branchStatsGrid');
            grid.innerHTML = '';
            branches.forEach(b => {
                const count = employees.filter(e => e.branch === b).length;
                grid.innerHTML += `
                    <div class="branch-stat-box">
                        <span class="branch-stat-count">${count}</span>
                        <span class="branch-stat-name">${b}</span>
                    </div>`;
            });
        }

        function openBranchModal() {
            updateUI();
            document.getElementById('branchModal').classList.add('open');
        }
        function addNewBranch() {
            const input = document.getElementById('newBranchName');
            const name = input.value.trim();
            if(name && !branches.includes(name)) { branches.push(name); saveData(); input.value = ''; }
        }
        function deleteBranch(name) {
            if(confirm(`Delete ${name}?`)) { branches = branches.filter(b => b !== name); saveData(); }
        }

        // --- SAVE / ADD STAFF ---
        function openAddModal() {
            document.getElementById('staffForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('modalTitle').innerText = "Add New Staff Member";
            document.getElementById('staffModal').classList.add('open');
        }
        function editEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if(!emp) return;

            document.getElementById('editId').value = emp.id;
            document.getElementById('modalTitle').innerText = `Edit: ${emp.name}`;
            document.getElementById('staffModal').classList.add('open');
            
            // Fill Form
            ['inpId', 'inpName', 'inpNationality', 'inpBranch', 'inpJoiningDate', 'inpIdNumber', 'inpPassExp', 'inpMedicalExp', 'inpIdVisaExp', 'inpNotes'].forEach(k => document.getElementById(k).value = emp[k.replace('Nationality', 'Nationality').replace('PassportExp', 'passportExp')] || "");
            
            ['inpStaffType', 'inpGender', 'inpPassport', 'inpCV', 'inpOffer', 'inpTipCenter'].forEach(k => document.getElementById(k).value = emp[k.replace('passport','passport')] || "false");
            
            document.getElementById('inpPhotos').value = emp.photos || 0;
        }

        function saveStaff() {
            const editId = document.getElementById('editId').value;
            const id = document.getElementById('inpId').value.trim();
            
            if(!id || !document.getElementById('inpName').value) { alert("ID and Name are required"); return; }

            const formData = {
                id, 
                name: document.getElementById('inpName').value.trim(),
                staffType: document.getElementById('inpStaffType').value,
                nationality: document.getElementById('inpNationality').value,
                gender: document.getElementById('inpGender').value,
                designation: "",
                branch: document.getElementById('inpBranch').value,
                joiningDate: document.getElementById('inpJoiningDate').value,
                idNumber: document.getElementById('inpIdNumber').value,
                photos: parseInt(document.getElementById('inpPhotos').value) || 0,
                cv: document.getElementById('inpCV').value === 'true',
                offerLetter: document.getElementById('inpOffer').value === 'true',
                passport: document.getElementById('inpPassport').value === 'true',
                passportExpiry: document.getElementById('inpPassExp').value,
                medicalExpiry: document.getElementById('inpMedicalExp').value,
                idVisaExpiry: document.getElementById('inpIdVisaExp').value,
                tipCenter: document.getElementById('inpTipCenter').value === 'true',
                notes: document.getElementById('inpNotes').value
            };

            if(editId) {
                const idx = employees.findIndex(e => e.id === editId);
                if(idx !== -1) employees[idx] = formData;
            } else {
                if(employees.some(e => e.id === id)) { alert("ID Exists"); return; }
                employees.unshift(formData);
            }

            saveData();
            document.getElementById('searchInput').value = ''; // Clear Search
            filterData();
            document.getElementById('staffModal').classList.remove('open');
            showToast("Saved Successfully");
        }

        function deleteEmployee(id) {
            if(confirm("Delete record?")) {
                employees = employees.filter(e => e.id !== id);
                saveData();
                filterData();
            }
        }

        // --- QUICK ADD ---
        function openQuickAddModal() {
            document.getElementById('qkId').value = '';
            document.getElementById('qkName').value = '';
            document.getElementById('qkNotes').value = '';
            document.getElementById('quickAddModal').classList.add('open');
        }
        function saveQuickAdd() {
            const id = document.getElementById('qkId').value.trim();
            const name = document.getElementById('qkName').value.trim();
            const branch = document.getElementById('qkBranch').value;
            const notes = document.getElementById('qkNotes').value;
            
            if(!id || !name || !branch) { alert("ID, Name, Branch Required"); return; }
            
            employees.unshift({
                id, name, branch, nationality: "", gender: "Male", staffType: "new",
                joiningDate: new Date().toISOString().split('T')[0], photos: 0, cv: false, 
                offerLetter: false, passport: false, medicalExpiry: "", idVisaExp: "", 
                tipCenter: false, notes
            });
            saveData();
            closeModal('quickAddModal');
            showToast("Added");
        }

        // --- EXCEL FIX (BOM) ---
        function exportToCSV() {
            // Add BOM for Arabic/Excel Support
            let csvContent = "\uFEFF"; 
            csvContent += "Status,Icon,ID,Name,Type,Nationality,Branch,Joining Date,Passport Exp,Medical Exp,ID Visa Exp,Notes\n";
            
            employees.forEach(e => {
                const s = getEmployeeStatus(e);
                const row = [
                    s.label, s.icon, e.id, e.name, e.staffType||'new', e.nationality||'', e.branch||'', 
                    e.joiningDate||'', e.passportExpiry||'', e.medicalExpiry||'', e.idVisaExp||'', e.notes||''
                ].map(f => `"${f}"`).join(",");
                csvContent += row + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `HR_Report_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Excel Downloaded");
        }

        // --- EMAIL FIX ---
        function sendReportEmail() {
            const total = employees.length;
            const working = employees.filter(e => getEmployeeStatus(e).class === 'status-working').length;
            const issues = total - working;
            
            const body = `HR Report - ${new Date().toLocaleDateString()}\n\nTotal Staff: ${total}\nWorking: ${working}\nIssues: ${issues}\n\nGenerated by Crispy Chicken System.`;
            
            const email1 = "mohammed.t@crispychicken.rest";
            const email2 = "kenawe@crispychicken.rest";
            
            window.location.href = `mailto:${email1},${email2}?subject=HR Report - ${new Date().toLocaleDateString()}&body=${encodeURIComponent(body)}`;
            showToast("Email Client Opened");
        }

        // --- PRINT FIX ---
        function printByIdInput() {
            const id = document.getElementById('searchInput').value.trim();
            if(employees.length === 0) { alert("No Data"); return; }
            
            const emp = employees.find(e => e.id.toLowerCase() === id.toLowerCase() || e.name.toLowerCase() === id.toLowerCase());
            if(emp) {
                printStaff(emp);
            } else {
                alert("Not Found");
            }
        }

        function printCurrentModalView() {
            const id = document.getElementById('editId').value;
            if(id) {
                const emp = employees.find(e => e.id === id);
                if(emp) printStaff(emp);
            } else {
                alert("No record loaded. Please Click Edit (Pencil) first.");
            }
        }

        function printStaff(emp) {
            const s = getEmployeeStatus(emp);
            const printHTML = `
                <div class="print-header"><h1>CRISPY CHICKEN</h1><h3>Employee Status</h3></div>
                <div class="print-status ${s.class === 'status-working' ? 'ready' : 'pending'}">
                    STATUS: ${s.label.toUpperCase()}
                </div>
                <div class="print-grid">
                    <div class="print-box"><div class="print-label">ID</div><div class="print-value">${emp.id}</div></div>
                    <div class="print-box"><div class="print-label">Name</div><div class="print-value">${emp.name}</div></div>
                    <div class="print-box"><div class="print-label">Branch</div><div class="print-value">${emp.branch}</div></div>
                    <div class="print-box"><div class="print-label">Joining</div><div class="print-value">${emp.joiningDate}</div></div>
                </div>
                <div style="margin-top: 30px; text-align: right;">Printed: ${new Date().toLocaleString()}</div>
            `;
            document.getElementById('printArea').innerHTML = printHTML;
            
            // Force print after a slight delay to ensure DOM renders
            setTimeout(() => { window.print(); }, 100);
        }

        // --- HELPERS ---
        function openHelpModal() {
            alert(`QUICK GUIDE:
‚Ä¢ Excel: Click 'Excel' to download CSV (with Arabic support).
‚Ä¢ Print: Type ID in search box -> Click 'Print Status'.
‚Ä¢ Email: Opens default email app.`);
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function showToast(msg) {
            const t = document.getElementById("toast"); t.innerText = msg; t.className = "toast show";
            setTimeout(() => t.className = t.className.replace("show", ""), 3000);
        }
        
        // Notification Check
        function checkExpiringDocuments() {
            notifications = [];
            employees.forEach(emp => {
                const today = new Date(); today.setHours(0,0,0,0);
                ['passportExpiry', 'medicalExpiry', 'idVisaExp'].forEach(field => {
                    if(emp[field]) {
                        const diff = Math.ceil((new Date(emp[field]) - today) / (1000*60*60*24));
                        if(diff <= 0) notifications.push({ type: 'expired', title: `${emp.name} Expired`, date: emp[field] });
                        else if(diff <= 30) notifications.push({ type: 'warning', title: `${emp.name} Expiring Soon`, date: emp[field] });
                    }
                });
            });
            
            const list = document.getElementById('notificationList');
            list.innerHTML = notifications.length === 0 ? '<div style="padding:10px">No expiring documents</div>' : '';
            
            notifications.forEach(n => {
                list.innerHTML += `<div class="notification-item"><div class="notification-icon ${n.type}"><i class="fas fa-exclamation-circle"></i></div><div class="notification-content">${n.title}<br><small>${n.date}</small></div></div>`;
            });
        }
        function toggleNotifications() { document.getElementById('notificationPanel').classList.toggle('open'); }

    </script>
</body>
</html>
